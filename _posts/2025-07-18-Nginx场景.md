---
title: Nginxåœºæ™¯
date: 2025-07-18 21:52:18 +0800
categories: [Nginx, åœºæ™¯]
tags: [Nginx]     # TAG names should always be lowercase
---
## ğŸ”¹1. Nginx æœ€é‡è¦çš„å°±æ˜¯é…ç½®å—ï¼Ÿ

### âœ… æ˜¯çš„ï¼Œ**é…ç½®æ˜¯Nginxçš„æ ¸å¿ƒ**ã€‚

* Nginx æœ¬èº«æ˜¯ä¸€ä¸ªéå¸¸è½»é‡ã€æ¨¡å—åŒ–çš„é«˜æ€§èƒ½æœåŠ¡å™¨ï¼Œå‡ ä¹æ‰€æœ‰åŠŸèƒ½éƒ½ç”±é…ç½®æ–‡ä»¶æ§åˆ¶ã€‚
* Nginx æ²¡æœ‰å¤æ‚çš„å†…éƒ¨é€»è¾‘ï¼Œå®ƒçš„â€œå¼ºå¤§â€åœ¨äºçµæ´»çš„é…ç½®èƒ½åŠ›ï¼Œèƒ½å®ç°ä»åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡åˆ°é«˜å¹¶å‘ç½‘ç«™æœåŠ¡ç­‰å¤šç§ç”¨é€”ã€‚

**æ‰€ä»¥ï¼ŒæŒæ¡é…ç½®ï¼Œæ˜¯æŒæ¡ Nginx çš„æ ¸å¿ƒã€‚**

---

## ğŸ”¹2. æŒæ¡äº†é…ç½® = æŒæ¡äº† Nginx å—ï¼Ÿ

### âœ… å¤§ä½“ä¸Šå¯ä»¥è¿™ä¹ˆè¯´ï¼Œä½†æ›´å‡†ç¡®çš„è¯´æ³•æ˜¯ï¼š

> **æŒæ¡å„ç§å®é™…åœºæ™¯ä¸‹çš„ Nginx é…ç½®ï¼Œæ‰ç®—çœŸæ­£æŒæ¡äº† Nginxã€‚**

å› ä¸ºï¼š

* å•çº¯è®°ä½é…ç½®æŒ‡ä»¤æ²¡ç”¨ï¼Œå¿…é¡»ç†è§£ **è¿™äº›é…ç½®èƒŒåçš„åœºæ™¯éœ€æ±‚** å’Œ **Nginx çš„è¡Œä¸ºæœºåˆ¶**ã€‚
* è¿˜éœ€è¦äº†è§£ Nginx çš„æ¨¡å—ã€æ—¥å¿—è°ƒè¯•ã€æ€§èƒ½è°ƒä¼˜ã€å®‰å…¨ç­‰ç»´åº¦ã€‚

---

## ğŸ”¹3. ä½ çš„æ–¹å‘å¾ˆå¯¹ â€”â€” ä»åœºæ™¯å…¥æ‰‹éå¸¸åˆé€‚ï¼

è¿™æ˜¯å¾ˆå¤šèµ„æ·±å·¥ç¨‹å¸ˆçš„å­¦ä¹ æ–¹å¼ï¼Œå› ä¸ºï¼š

> **æ¯ä¸€ç§çœŸå®ä¸šåŠ¡åœºæ™¯ï¼Œéƒ½æ˜¯å¯¹ Nginx èƒ½åŠ›çš„ä¸€æ¬¡å®Œæ•´åº”ç”¨ã€‚**

---

## ğŸ”¹4. å­¦ä¹ è·¯å¾„ï¼šé€šè¿‡åœºæ™¯æŒæ¡ Nginx

æˆ‘ä»¬ä»¥â€œä»ç®€å•åˆ°å¤æ‚â€çš„åœºæ™¯å‡ºå‘ï¼Œå¸®ä½ å…¨é¢æŒæ¡ Nginxï¼š

| åœºæ™¯               | å­¦ä¹ é‡ç‚¹                                 | ç¤ºä¾‹                           |
| ---------------- | ------------------------------------ | ---------------------------- |
| âœ… é™æ€ç½‘ç«™æ‰˜ç®¡         | `location`ã€`root`ã€`index`            | ç”¨ Nginx éƒ¨ç½² HTMLã€å›¾ç‰‡ã€JS æ–‡ä»¶     |
| âœ… åå‘ä»£ç†           | `proxy_pass`ã€`upstream`              | æŠŠæµé‡è½¬å‘åˆ° Nodeã€Flaskã€Spring ç­‰åç«¯ |
| âœ… è´Ÿè½½å‡è¡¡           | `upstream` å¤šåç«¯é…ç½®                     | åšè½®è¯¢ã€IP å“ˆå¸Œã€å¥åº·æ£€æŸ¥ç­‰              |
| âœ… HTTPS é…ç½®       | `ssl_certificate`ã€`ssl_protocols`    | ä½¿ç”¨ Let's Encryptã€å•åŸŸ/å¤šåŸŸè¯ä¹¦é…ç½®   |
| âœ… åŠ¨é™åˆ†ç¦»           | æ­£åˆ™åŒ¹é…ä¸åŒåç¼€åšä¸åŒå¤„ç†                        | åŠ¨æ€ç”¨ proxyï¼Œé™æ€èµ°æœ¬åœ°              |
| âœ… Gzip å‹ç¼©        | `gzip on` ç­‰                          | æå‡ç½‘é¡µä¼ è¾“é€Ÿåº¦                     |
| âœ… åçˆ¬è™« / å®‰å…¨       | `limit_req`ã€é»‘åå•ã€Fail2Ban             | é˜²æ­¢æ¶æ„è¯·æ±‚                       |
| âœ… å­è·¯å¾„ä»£ç†          | `location /api/` è½¬å‘                  | æ”¯æŒå‰åç«¯åˆ†ç¦»é¡¹ç›®çš„ API ä»£ç†            |
| âœ… WebSocket æ”¯æŒ   | `proxy_http_version 1.1` + `Upgrade` | èŠå¤©ç³»ç»Ÿç­‰å®æ—¶é€šä¿¡                    |
| âœ… é…åˆå‰ç«¯æ„å»ºç³»ç»Ÿ       | Vue/React çš„ `history` æ¨¡å¼é€‚é…           | `try_files` é…ç½®               |
| âœ… Nginx + Docker | `docker-compose` ä¸­ä½¿ç”¨ nginx åä»£        | å¤šæœåŠ¡ååŒéƒ¨ç½²                      |
| âœ… æ€§èƒ½ä¼˜åŒ–           | `worker_processes`ã€ç¼“å­˜é…ç½®              | å¤„ç†é«˜å¹¶å‘åœºæ™¯                      |
| âœ… æ—¥å¿—ä¸ç›‘æ§          | `access_log`ã€`log_format`            | ç»“åˆ ELK æˆ– Prometheus          |

---

## ğŸ”¹5. è¡¥å……èƒ½åŠ›ï¼šä¸ä»…ä»…æ˜¯é…ç½®æ–‡ä»¶

ä¸ºäº†çœŸæ­£æŒæ¡ Nginxï¼Œè¿˜å»ºè®®äº†è§£ä»¥ä¸‹å†…å®¹ï¼š

| é¢†åŸŸ        | å†…å®¹                                     |
| --------- | -------------------------------------- |
| ğŸ”§ è°ƒè¯•èƒ½åŠ›   | åˆ©ç”¨ `error.log`ã€`access.log` å®šä½é—®é¢˜       |
| ğŸ“¦ æ¨¡å—æœºåˆ¶   | å†…ç½®æ¨¡å— vs ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œæ¯”å¦‚ `ngx_http_lua_module` |
| ğŸš§ é«˜å¯ç”¨éƒ¨ç½²  | é…åˆ Keepalivedã€Consul åšçƒ­å¤‡               |
| ğŸ” å®‰å…¨æœºåˆ¶   | é˜²ç›—é“¾ã€é™åˆ¶æ–¹æ³•ã€éšè—ç‰ˆæœ¬å·ç­‰                        |
| ğŸ§© Lua æ‰©å±• | ç”¨ Lua å†™ä¸€äº›è½»é‡ä¸šåŠ¡é€»è¾‘                        |
| ğŸ“ˆ æ€§èƒ½ç›‘æ§   | `stub_status` æˆ–æ¥å…¥ Grafana å±•ç¤ºçŠ¶æ€         |

---

## âœ… æ€»ç»“

> **æŒæ¡å„ç§åœºæ™¯ä¸‹çš„ Nginx é…ç½® â‰ˆ æŒæ¡äº† Nginxã€‚**

é…ç½®æ˜¯æ ¸å¿ƒï¼Œä½†æœ€ç»ˆç›®æ ‡æ˜¯ï¼š

* çœ‹å¾—æ‡‚åˆ«äººå†™çš„å¤æ‚é…ç½®
* å†™å¾—å‡ºæ»¡è¶³ä¸šåŠ¡åœºæ™¯çš„é…ç½®
* èƒ½æ’æŸ¥é—®é¢˜ã€åšä¼˜åŒ–

---


=============================
ğŸ§¾ NGINX é…ç½®å—å…¨æ™¯ Cheatsheet
=============================

ä¸€ã€ğŸŒ Main å—ï¼ˆå…¨å±€å—ï¼‰
------------------------
ä½ç½®ï¼šnginx.conf é¡¶å±‚

å¸¸ç”¨é…ç½®æŒ‡ä»¤ï¼š
- `user nginx;`                    # æŒ‡å®šè¿è¡Œç”¨æˆ·
- `worker_processes auto;`         # å·¥ä½œè¿›ç¨‹æ•°ï¼ˆå»ºè®®ä½¿ç”¨ autoï¼‰
- `error_log /var/log/nginx/error.log warn;` # é”™è¯¯æ—¥å¿—è·¯å¾„å’Œçº§åˆ«
- `pid /var/run/nginx.pid;`        # PID æ–‡ä»¶è·¯å¾„
- `daemon on|off;`                 # æ˜¯å¦åå°è¿è¡Œ
- `worker_rlimit_nofile 65535;`   # è¿›ç¨‹å¯æ‰“å¼€æœ€å¤§æ–‡ä»¶æ•°

äºŒã€ğŸ” Events å—
------------------------
ä½ç½®ï¼šMain å—å†…

å¸¸ç”¨é…ç½®æŒ‡ä»¤ï¼š
- `worker_connections 1024;`       # æ¯ä¸ª worker æœ€å¤§è¿æ¥æ•°
- `use epoll|kqueue|select;`       # äº‹ä»¶æ¨¡å‹ï¼ˆLinux æ¨è epollï¼‰
- `multi_accept on;`               # åŒæ—¶æ¥å—å¤šä¸ªè¿æ¥

ä¸‰ã€ğŸŒ HTTP å—
------------------------
ä½ç½®ï¼šMain å—å†…ï¼Œæ ¸å¿ƒéƒ¨åˆ†

é€šç”¨è®¾ç½®ï¼š
- `include mime.types;`            # å¼•å…¥ MIME ç±»å‹
- `default_type application/octet-stream;` # é»˜è®¤ MIME ç±»å‹
- `sendfile on;`                   # å¯ç”¨é›¶æ‹·è´
- `tcp_nopush on;`                 # å‡å°‘ç½‘ç»œåŒ…æ•°é‡
- `keepalive_timeout 65;`          # HTTP Keep-Alive è¶…æ—¶
- `server_tokens off;`             # éšè— Nginx ç‰ˆæœ¬ä¿¡æ¯

æ—¥å¿—é…ç½®ï¼š
- `log_format main '...';`         # æ—¥å¿—æ ¼å¼å®šä¹‰
- `access_log /var/log/nginx/access.log main;`

å‹ç¼©é…ç½®ï¼š
- `gzip on;`
- `gzip_types text/plain text/css application/json ...;`
- `gzip_min_length 1024;`

ç¼“å­˜é…ç½®ï¼š
- `proxy_cache_path /data/nginx/cache levels=1:2 keys_zone=mycache:10m max_size=1g inactive=60m use_temp_path=off;`
- `proxy_cache mycache;`

åå‘ä»£ç†ï¼š
- `proxy_pass http://backend;`
- `proxy_set_header Host $host;`
- `proxy_http_version 1.1;`
- `proxy_cache_bypass $http_upgrade;`

è·¨åŸŸï¼š
- `add_header Access-Control-Allow-Origin *;`

å››ã€ğŸ  Server å—ï¼ˆè™šæ‹Ÿä¸»æœºï¼‰
------------------------
ä½ç½®ï¼šHTTP å—å†…ï¼Œå¯å¤šä¸ª

é€šç”¨é…ç½®ï¼š
- `listen 80;`                     # ç›‘å¬ç«¯å£
- `listen 443 ssl;`                # ç›‘å¬ HTTPS
- `server_name example.com;`      # åŸŸå
- `root /var/www/html;`           # ç½‘ç«™æ ¹ç›®å½•
- `index index.html index.htm;`   # é»˜è®¤é¦–é¡µæ–‡ä»¶

HTTPS é…ç½®ï¼š
- `ssl_certificate /etc/nginx/ssl/cert.pem;`
- `ssl_certificate_key /etc/nginx/ssl/cert.key;`
- `ssl_protocols TLSv1.2 TLSv1.3;`
- `ssl_ciphers HIGH:!aNULL:!MD5;`

é‡å®šå‘é…ç½®ï¼š
- `return 301 https://$host$request_uri;`
- `rewrite ^/old/(.*)$ /new/$1 permanent;`

å®‰å…¨é™åˆ¶ï¼š
- `deny all;`
- `allow 192.168.0.0/24;`
- `limit_conn addr 10;`

äº”ã€ğŸ“ Location å—ï¼ˆè·¯å¾„å¤„ç†ï¼‰
------------------------
ä½ç½®ï¼šServer å—å†…ï¼Œå¯å¤šä¸ª

åŒ¹é…æ–¹å¼ï¼š
- `location = /exact {}`       # ç²¾ç¡®åŒ¹é…
- `location /prefix {}`        # å‰ç¼€åŒ¹é…
- `location ~ \.php$ {}`       # æ­£åˆ™åŒ¹é…ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
- `location ~* \.(jpg|png)$ {}`# æ­£åˆ™åŒ¹é…ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰

é…ç½®æŒ‡ä»¤ï¼š
- `proxy_pass http://127.0.0.1:3000;`
- `root /var/www/static;`
- `alias /data/images/;`       # æ˜ å°„ç›®å½•
- `try_files $uri $uri/ /index.html;`
- `index index.html;`
- `add_header X-Powered-By Nginx;`
- `expires 7d;`                # æµè§ˆå™¨ç¼“å­˜æ§åˆ¶

WebSocket æ”¯æŒï¼š
- `proxy_http_version 1.1;`
- `proxy_set_header Upgrade $http_upgrade;`
- `proxy_set_header Connection "upgrade";`

è®¿é—®æ§åˆ¶ï¼š
- `auth_basic "Restricted";`
- `auth_basic_user_file /etc/nginx/.htpasswd;`

å…­ã€ğŸ”— Upstream å—ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
------------------------
ä½ç½®ï¼šHTTP å—å†…

ç¤ºä¾‹é…ç½®ï¼š
```
upstream backend {
    server backend1.example.com weight=3;
    server backend2.example.com max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8000 backup;
}
```

æ”¯æŒçš„ç®—æ³•ï¼š
- `round-robin`ï¼ˆé»˜è®¤ï¼‰
- `ip_hash`
- `least_conn`
- `hash $request_uri consistent;`

ä¸ƒã€ğŸ§­ Map å—ï¼ˆå˜é‡æ˜ å°„ï¼‰
------------------------
ä½ç½®ï¼šHTTP å—å†…

ç¤ºä¾‹ï¼š
```
map $http_user_agent $is_bot {
    default 0;
    ~*googlebot 1;
    ~*bingbot 1;
}
```

å…«ã€ğŸ“ Includeï¼ˆå¼•å…¥é…ç½®ï¼‰
------------------------
- `include /etc/nginx/conf.d/*.conf;`
- `include mime.types;`

å¸¸ç”¨äºæ¨¡å—åŒ–ç®¡ç†é…ç½®æ–‡ä»¶ã€‚

